<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paper Map</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    /* Theme variables */
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --border-color: #30363d;
      --text-primary: #f0f6fc;
      --text-secondary: #c9d1d9;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --plot-bg: #0d1117;
      --plot-grid: #21262d;
      --plot-zero: #30363d;
    }

    [data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f6f8fa;
      --bg-tertiary: #eaeef2;
      --border-color: #d0d7de;
      --text-primary: #1f2328;
      --text-secondary: #424a53;
      --text-muted: #656d76;
      --accent: #0969da;
      --plot-bg: #ffffff;
      --plot-grid: #eaeef2;
      --plot-zero: #d0d7de;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-secondary);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    header {
      padding: 12px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    header h1 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .stats {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
      margin-left: auto;
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .control-group label {
      font-size: 12px;
      color: var(--text-muted);
    }
    input[type="number"], select, input[type="text"] {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      width: 70px;
    }
    select { width: auto; }
    input[type="checkbox"] {
      accent-color: var(--accent);
    }
    button {
      background: #238636;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    button:hover { background: #2ea043; }

    /* Theme toggle */
    .theme-toggle {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .theme-toggle:hover {
      background: var(--border-color);
    }

    /* Main content */
    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Plot */
    #plot {
      flex: 1;
      min-width: 0;
    }

    /* Detail panel */
    .detail-panel {
      width: 0;
      min-width: 0;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border-color);
      overflow-y: auto;
      overflow-x: hidden;
      padding: 0;
    }
    .detail-panel.active {
      width: 350px;
      min-width: 350px;
      padding: 16px;
    }
    .detail-panel h2 {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      line-height: 1.4;
    }
    .detail-panel .meta {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .detail-panel .meta span {
      display: inline-block;
      margin-right: 12px;
    }
    .detail-panel .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    .badge.paper { background: #388bfd33; color: #58a6ff; }
    .badge.app { background: #a371f733; color: #bc8cff; }
    .badge.cluster {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }
    .detail-panel .abstract {
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-muted);
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }
    .detail-panel .links {
      margin-top: 12px;
    }
    .detail-panel .links a {
      color: var(--accent);
      font-size: 12px;
      text-decoration: none;
      margin-right: 12px;
    }
    .detail-panel .links a:hover { text-decoration: underline; }
    .detail-panel .similar-papers {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }
    .detail-panel .similar-papers h3 {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .detail-panel .similar-papers ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .detail-panel .similar-papers li {
      font-size: 12px;
      padding: 6px 0;
      border-bottom: 1px solid var(--bg-tertiary);
      cursor: pointer;
      color: var(--text-secondary);
    }
    .detail-panel .similar-papers li:hover {
      color: var(--accent);
    }
    .detail-panel .similar-papers .year {
      color: var(--text-muted);
      font-size: 11px;
    }

    /* Legend */
    .legend {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .legend-diamond {
      width: 10px;
      height: 10px;
      background: #bc8cff;
      transform: rotate(45deg);
    }
  </style>
</head>
<body>
  <header>
    <h1>Paper Map</h1>
    <button class="theme-toggle" id="themeToggle" title="Toggle theme">üåô</button>
    <div class="stats" id="stats">Loading...</div>
    <div class="legend">
      <div class="legend-item">
        <div class="legend-dot" style="background: #58a6ff;"></div>
        <span>Papers</span>
      </div>
      <div class="legend-item">
        <div class="legend-diamond"></div>
        <span>Apps/Services</span>
      </div>
    </div>
    <div class="controls">
      <div class="control-group">
        <label>Min Year:</label>
        <input type="number" id="minYear" value="1990" min="1990" max="2025">
      </div>
      <div class="control-group">
        <label>Min Venue Quality:</label>
        <select id="minVenue">
          <option value="0">All</option>
          <option value="3">3+</option>
          <option value="4">4+</option>
          <option value="5">5 only</option>
        </select>
      </div>
      <div class="control-group">
        <label>Cluster:</label>
        <select id="clusterFilter">
          <option value="all">All</option>
        </select>
      </div>
      <div class="control-group">
        <input type="checkbox" id="papersOnly">
        <label for="papersOnly">Papers only</label>
      </div>
      <div class="control-group">
        <input type="checkbox" id="notesOnly">
        <label for="notesOnly">With notes</label>
      </div>
      <div class="control-group">
        <label>Tag:</label>
        <input type="text" id="tagFilter" placeholder="e.g. impact-high" style="width: 100px;">
      </div>
      <div class="control-group">
        <label>Search:</label>
        <input type="text" id="searchFilter" placeholder="keyword in notes" style="width: 120px;">
      </div>
      <div class="control-group" style="border-left: 1px solid #30363d; padding-left: 16px;">
        <label>Intersection:</label>
        <select id="intersectCluster1" style="width: 90px;">
          <option value="">C1</option>
        </select>
        <span style="color: #8b949e;">‚Üî</span>
        <select id="intersectCluster2" style="width: 90px;">
          <option value="">C2</option>
        </select>
        <button id="findIntersection" style="background: #8b5cf6;">Find</button>
      </div>
      <button id="applyFilter">Apply</button>
      <button id="resetFilter" style="background: #30363d;">Reset</button>
    </div>
  </header>

  <div class="main-content">
    <div id="plot"></div>
    <div class="detail-panel" id="detailPanel">
      <h2 id="detailTitle">-</h2>
      <div class="meta" id="detailMeta"></div>
      <div class="links" id="detailLinks"></div>
      <div class="abstract" id="detailAbstract"></div>
      <div class="similar-papers" id="similarPapers"></div>
    </div>
  </div>

  <script>
    let allPapers = [];
    let currentFiltered = [];
    let clusterCentroids = {};
    let clusterLabels = {};
    const CLUSTER_COLORS = [
      '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7',
      '#dfe6e9', '#a29bfe', '#fd79a8', '#00b894', '#e17055',
      '#74b9ff', '#55efc4', '#b2bec3', '#ffeaa7', '#fab1a0'
    ];

    async function loadData() {
      try {
        const resp = await fetch('papers.json');
        const data = await resp.json();

        // ÏÉà Ìè¨Îß∑ (papers Î∞∞Ïó¥ + centroids) vs Í∏∞Ï°¥ Ìè¨Îß∑ (Î∞∞Ïó¥Îßå)
        if (data.papers) {
          allPapers = data.papers;
          clusterCentroids = data.cluster_centroids || {};
          clusterLabels = data.cluster_labels || {};
        } else {
          allPapers = data;
        }

        // Populate cluster filter with labels
        const clusters = [...new Set(allPapers.map(p => p.cluster))].sort((a,b) => a-b);
        const clusterSelect = document.getElementById('clusterFilter');
        const intersect1 = document.getElementById('intersectCluster1');
        const intersect2 = document.getElementById('intersectCluster2');

        clusters.forEach(c => {
          const sample = allPapers.find(p => p.cluster === c);
          const label = clusterLabels[c] || sample?.cluster_label || '';

          // Í∏∞Ï°¥ ÌÅ¥Îü¨Ïä§ÌÑ∞ ÌïÑÌÑ∞
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = `${c}: ${label}`;
          clusterSelect.appendChild(opt);

          // ÍµêÏ∞®Ï†ê ÏÑ†ÌÉù 1
          const opt1 = document.createElement('option');
          opt1.value = c;
          opt1.textContent = `${c}: ${label.substring(0, 20)}`;
          intersect1.appendChild(opt1);

          // ÍµêÏ∞®Ï†ê ÏÑ†ÌÉù 2
          const opt2 = document.createElement('option');
          opt2.value = c;
          opt2.textContent = `${c}: ${label.substring(0, 20)}`;
          intersect2.appendChild(opt2);
        });

        currentFiltered = [...allPapers];
        render(currentFiltered);
        updateStats(currentFiltered);
      } catch (e) {
        document.getElementById('stats').textContent = 'Error loading papers.json';
        console.error(e);
      }
    }

    function filterPapers() {
      const minYear = parseInt(document.getElementById('minYear').value) || 0;
      const minVenue = parseFloat(document.getElementById('minVenue').value) || 0;
      const clusterVal = document.getElementById('clusterFilter').value;
      const papersOnly = document.getElementById('papersOnly').checked;
      const notesOnly = document.getElementById('notesOnly').checked;
      const tagFilter = document.getElementById('tagFilter').value.toLowerCase().trim();
      const searchFilter = document.getElementById('searchFilter').value.toLowerCase().trim();

      return allPapers.filter(p => {
        if (p.year && p.year < minYear) return false;
        if (p.venue_quality < minVenue) return false;
        if (clusterVal !== 'all' && p.cluster !== parseInt(clusterVal)) return false;
        if (papersOnly && !p.is_paper) return false;
        if (notesOnly && !p.has_notes) return false;
        if (tagFilter && (!p.tags || !p.tags.toLowerCase().includes(tagFilter))) return false;
        if (searchFilter) {
          const searchText = `${p.title} ${p.abstract} ${p.notes || ''}`.toLowerCase();
          if (!searchText.includes(searchFilter)) return false;
        }
        return true;
      });
    }

    function updateStats(papers) {
      const paperCount = papers.filter(p => p.is_paper).length;
      const appCount = papers.filter(p => !p.is_paper).length;
      document.getElementById('stats').textContent =
        `${papers.length} items (${paperCount} papers, ${appCount} apps/services)`;
    }

    function render(papers) {
      // Separate papers and apps
      const paperItems = papers.filter(p => p.is_paper);
      const appItems = papers.filter(p => !p.is_paper);

      // Papers trace (circles)
      const paperTrace = {
        x: paperItems.map(p => p.x),
        y: paperItems.map(p => p.y),
        text: paperItems.map(p =>
          `<b>${p.title}</b><br>` +
          `${p.venue || 'N/A'} (${p.year || 'N/A'})<br>` +
          `Cluster ${p.cluster}: ${p.cluster_label || ''}`
        ),
        customdata: paperItems,
        mode: 'markers',
        type: 'scatter',
        name: 'Papers',
        marker: {
          size: paperItems.map(p => 8 + p.venue_quality * 2),
          color: paperItems.map(p => CLUSTER_COLORS[p.cluster % CLUSTER_COLORS.length]),
          opacity: 0.8,
          line: { width: 1, color: '#0d1117' }
        },
        hovertemplate: '%{text}<extra></extra>'
      };

      // Apps trace (diamonds)
      const appTrace = {
        x: appItems.map(p => p.x),
        y: appItems.map(p => p.y),
        text: appItems.map(p =>
          `<b>${p.title}</b><br>` +
          `App/Service<br>` +
          `Cluster ${p.cluster}: ${p.cluster_label || ''}`
        ),
        customdata: appItems,
        mode: 'markers',
        type: 'scatter',
        name: 'Apps/Services',
        marker: {
          size: 14,
          symbol: 'diamond',
          color: appItems.map(p => CLUSTER_COLORS[p.cluster % CLUSTER_COLORS.length]),
          opacity: 0.9,
          line: { width: 2, color: '#bc8cff' }
        },
        hovertemplate: '%{text}<extra></extra>'
      };

      const isLight = document.documentElement.dataset.theme === 'light';
      const colors = isLight ? {
        bg: '#ffffff', grid: '#eaeef2', zero: '#d0d7de', text: '#656d76'
      } : {
        bg: '#0d1117', grid: '#21262d', zero: '#30363d', text: '#8b949e'
      };

      const layout = {
        margin: { l: 40, r: 20, t: 20, b: 40 },
        paper_bgcolor: colors.bg,
        plot_bgcolor: colors.bg,
        xaxis: {
          title: '',
          showgrid: true,
          gridcolor: colors.grid,
          zerolinecolor: colors.zero,
          tickfont: { color: colors.text }
        },
        yaxis: {
          title: '',
          showgrid: true,
          gridcolor: colors.grid,
          zerolinecolor: colors.zero,
          tickfont: { color: colors.text }
        },
        showlegend: false,
        hovermode: 'closest'
      };

      const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['lasso2d', 'select2d']
      };

      const plotDiv = document.getElementById('plot');
      Plotly.newPlot(plotDiv, [paperTrace, appTrace], layout, config).then(function() {
        plotDiv.on('plotly_click', function(data) {
          if (data.points && data.points[0]) {
            showDetail(data.points[0].customdata);
          }
        });
      });
    }

    function showDetail(item) {
      const panel = document.getElementById('detailPanel');
      panel.classList.add('active');
      setTimeout(() => Plotly.Plots.resize('plot'), 10);

      document.getElementById('detailTitle').textContent = item.title || 'Untitled';

      const typeClass = item.is_paper ? 'paper' : 'app';
      const typeLabel = item.is_paper ? 'Paper' : 'App/Service';

      document.getElementById('detailMeta').innerHTML = `
        <span class="badge ${typeClass}">${typeLabel}</span>
        <span class="badge cluster">Cluster ${item.cluster}: ${item.cluster_label || ''}</span>
        <br><br>
        <span><strong>Year:</strong> ${item.year || 'N/A'}</span>
        <span><strong>Venue:</strong> ${item.venue || 'N/A'}</span>
        <span><strong>Quality:</strong> ${item.venue_quality}/5</span>
        ${item.authors ? `<br><span><strong>Authors:</strong> ${item.authors.substring(0, 100)}${item.authors.length > 100 ? '...' : ''}</span>` : ''}
        ${item.tags ? `<br><span><strong>Tags:</strong> ${item.tags}</span>` : ''}
      `;

      let linksHtml = '';
      if (item.url) {
        linksHtml += `<a href="${item.url}" target="_blank">Open URL</a>`;
      }
      if (item.doi) {
        linksHtml += `<a href="https://doi.org/${item.doi}" target="_blank">DOI</a>`;
      }
      document.getElementById('detailLinks').innerHTML = linksHtml;

      document.getElementById('detailAbstract').textContent =
        item.abstract || 'No abstract available.';

      // Find similar papers (closest by x,y coordinates)
      const similar = findSimilarPapers(item, allPapers, 5);
      let similarHtml = '<h3>Similar Papers</h3><ul>';
      similar.forEach(p => {
        const title = p.title.length > 50 ? p.title.substring(0, 50) + '...' : p.title;
        similarHtml += `<li data-id="${p.id}">${title} <span class="year">(${p.year || 'N/A'})</span></li>`;
      });
      similarHtml += '</ul>';
      document.getElementById('similarPapers').innerHTML = similarHtml;

      // Click handler for similar papers
      document.querySelectorAll('#similarPapers li').forEach(li => {
        li.addEventListener('click', () => {
          const paperId = parseInt(li.dataset.id);
          const paper = allPapers.find(p => p.id === paperId);
          if (paper) showDetail(paper);
        });
      });
    }

    function findSimilarPapers(target, papers, n = 5) {
      return papers
        .filter(p => p.id !== target.id)
        .map(p => ({
          ...p,
          distance: Math.sqrt(Math.pow(p.x - target.x, 2) + Math.pow(p.y - target.y, 2))
        }))
        .sort((a, b) => a.distance - b.distance)
        .slice(0, n);
    }

    function findIntersectionPapers(cluster1, cluster2, threshold = 0.3) {
      // Îëê ÌÅ¥Îü¨Ïä§ÌÑ∞Ïùò Ï§ëÏã¨Ï†ê Í∞ÄÏ†∏Ïò§Í∏∞
      const c1 = clusterCentroids[cluster1];
      const c2 = clusterCentroids[cluster2];

      if (!c1 || !c2) {
        // centroidsÍ∞Ä ÏóÜÏúºÎ©¥ papersÏóêÏÑú ÏßÅÏ†ë Í≥ÑÏÇ∞
        const c1Papers = allPapers.filter(p => p.cluster === cluster1);
        const c2Papers = allPapers.filter(p => p.cluster === cluster2);

        const centroid1 = {
          x: c1Papers.reduce((s, p) => s + p.x, 0) / c1Papers.length,
          y: c1Papers.reduce((s, p) => s + p.y, 0) / c1Papers.length
        };
        const centroid2 = {
          x: c2Papers.reduce((s, p) => s + p.x, 0) / c2Papers.length,
          y: c2Papers.reduce((s, p) => s + p.y, 0) / c2Papers.length
        };

        return findPapersNearBothCentroids(centroid1, centroid2, threshold);
      }

      return findPapersNearBothCentroids(c1, c2, threshold);
    }

    function findPapersNearBothCentroids(c1, c2, threshold) {
      // Îëê Ï§ëÏã¨Ï†ê ÏÇ¨Ïù¥Ïùò Í±∞Î¶¨
      const distBetween = Math.sqrt(Math.pow(c2.x - c1.x, 2) + Math.pow(c2.y - c1.y, 2));

      // Í∞Å ÎÖºÎ¨∏ÏóêÏÑú Îëê Ï§ëÏã¨Ï†êÍπåÏßÄÏùò Í±∞Î¶¨ Í≥ÑÏÇ∞
      return allPapers
        .map(p => {
          const d1 = Math.sqrt(Math.pow(p.x - c1.x, 2) + Math.pow(p.y - c1.y, 2));
          const d2 = Math.sqrt(Math.pow(p.x - c2.x, 2) + Math.pow(p.y - c2.y, 2));
          // Îëê Í±∞Î¶¨Ïùò Ìï©Ïù¥ Îëê Ï§ëÏã¨Ï†ê Í±∞Î¶¨Ïùò (1 + threshold) Î∞∞ Ïù¥ÎÇ¥Î©¥ "ÍµêÏ∞®Ï†ê"
          // Ï¶â, Îëê ÌÅ¥Îü¨Ïä§ÌÑ∞ ÏÇ¨Ïù¥ Í≤ΩÎ°úÏóê Í∞ÄÍπåÏö¥ ÎÖºÎ¨∏Îì§
          const ratio = (d1 + d2) / distBetween;
          return { ...p, intersectionScore: ratio, d1, d2 };
        })
        .filter(p => p.intersectionScore <= 1 + threshold)
        .sort((a, b) => a.intersectionScore - b.intersectionScore);
    }

    // Event handlers
    document.getElementById('applyFilter').addEventListener('click', () => {
      currentFiltered = filterPapers();
      render(currentFiltered);
      updateStats(currentFiltered);
    });

    document.getElementById('resetFilter').addEventListener('click', () => {
      document.getElementById('minYear').value = '1990';
      document.getElementById('minVenue').value = '0';
      document.getElementById('clusterFilter').value = 'all';
      document.getElementById('papersOnly').checked = false;
      document.getElementById('notesOnly').checked = false;
      document.getElementById('tagFilter').value = '';
      document.getElementById('searchFilter').value = '';
      document.getElementById('intersectCluster1').value = '';
      document.getElementById('intersectCluster2').value = '';
      currentFiltered = [...allPapers];
      render(currentFiltered);
      updateStats(currentFiltered);
    });

    document.getElementById('findIntersection').addEventListener('click', () => {
      const c1 = document.getElementById('intersectCluster1').value;
      const c2 = document.getElementById('intersectCluster2').value;

      if (!c1 || !c2) {
        alert('Îëê ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');
        return;
      }
      if (c1 === c2) {
        alert('ÏÑúÎ°ú Îã§Î•∏ ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');
        return;
      }

      const intersectionPapers = findIntersectionPapers(parseInt(c1), parseInt(c2));
      if (intersectionPapers.length === 0) {
        alert('ÍµêÏ∞®Ï†ê ÎÖºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§');
        return;
      }

      currentFiltered = intersectionPapers;
      render(currentFiltered);
      updateStats(currentFiltered);

      // ÌÅ¥Îü¨Ïä§ÌÑ∞ ÎùºÎ≤® ÌëúÏãú
      const label1 = clusterLabels[c1] || '';
      const label2 = clusterLabels[c2] || '';
      document.getElementById('stats').textContent +=
        ` | Intersection: C${c1} ‚Üî C${c2}`;
    });

    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', () => {
      const html = document.documentElement;
      const isLight = html.dataset.theme === 'light';
      html.dataset.theme = isLight ? '' : 'light';
      document.getElementById('themeToggle').textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
      localStorage.setItem('theme', html.dataset.theme);
      render(currentFiltered);
    });

    // Load saved theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
      document.documentElement.dataset.theme = 'light';
      document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
    }

    // Load data
    loadData();
  </script>
</body>
</html>
