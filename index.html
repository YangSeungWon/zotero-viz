<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paper Map</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    header {
      padding: 12px 20px;
      background: #161b22;
      border-bottom: 1px solid #30363d;
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    header h1 {
      font-size: 18px;
      font-weight: 600;
      color: #f0f6fc;
    }
    .stats {
      font-size: 13px;
      color: #8b949e;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
      margin-left: auto;
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .control-group label {
      font-size: 12px;
      color: #8b949e;
    }
    input[type="number"], select {
      background: #21262d;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      width: 70px;
    }
    select { width: auto; }
    input[type="checkbox"] {
      accent-color: #58a6ff;
    }
    button {
      background: #238636;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    button:hover { background: #2ea043; }

    /* Main content */
    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Plot */
    #plot {
      flex: 1;
      min-width: 0;
    }

    /* Detail panel */
    .detail-panel {
      width: 350px;
      background: #161b22;
      border-left: 1px solid #30363d;
      overflow-y: auto;
      padding: 16px;
      display: none;
    }
    .detail-panel.active { display: block; }
    .detail-panel h2 {
      font-size: 15px;
      font-weight: 600;
      color: #f0f6fc;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    .detail-panel .meta {
      font-size: 12px;
      color: #8b949e;
      margin-bottom: 8px;
    }
    .detail-panel .meta span {
      display: inline-block;
      margin-right: 12px;
    }
    .detail-panel .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    .badge.paper { background: #388bfd33; color: #58a6ff; }
    .badge.app { background: #a371f733; color: #bc8cff; }
    .badge.cluster {
      background: #30363d;
      color: #c9d1d9;
    }
    .detail-panel .abstract {
      font-size: 13px;
      line-height: 1.6;
      color: #8b949e;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #30363d;
    }
    .detail-panel .links {
      margin-top: 12px;
    }
    .detail-panel .links a {
      color: #58a6ff;
      font-size: 12px;
      text-decoration: none;
      margin-right: 12px;
    }
    .detail-panel .links a:hover { text-decoration: underline; }

    /* Legend */
    .legend {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: #8b949e;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .legend-diamond {
      width: 10px;
      height: 10px;
      background: #bc8cff;
      transform: rotate(45deg);
    }
  </style>
</head>
<body>
  <header>
    <h1>Paper Map</h1>
    <div class="stats" id="stats">Loading...</div>
    <div class="legend">
      <div class="legend-item">
        <div class="legend-dot" style="background: #58a6ff;"></div>
        <span>Papers</span>
      </div>
      <div class="legend-item">
        <div class="legend-diamond"></div>
        <span>Apps/Services</span>
      </div>
    </div>
    <div class="controls">
      <div class="control-group">
        <label>Min Year:</label>
        <input type="number" id="minYear" value="1990" min="1990" max="2025">
      </div>
      <div class="control-group">
        <label>Min Venue Quality:</label>
        <select id="minVenue">
          <option value="0">All</option>
          <option value="3">3+</option>
          <option value="4">4+</option>
          <option value="5">5 only</option>
        </select>
      </div>
      <div class="control-group">
        <label>Cluster:</label>
        <select id="clusterFilter">
          <option value="all">All</option>
        </select>
      </div>
      <div class="control-group">
        <input type="checkbox" id="papersOnly">
        <label for="papersOnly">Papers only</label>
      </div>
      <div class="control-group">
        <input type="checkbox" id="notesOnly">
        <label for="notesOnly">With notes</label>
      </div>
      <button id="applyFilter">Apply</button>
      <button id="resetFilter" style="background: #30363d;">Reset</button>
    </div>
  </header>

  <div class="main-content">
    <div id="plot"></div>
    <div class="detail-panel" id="detailPanel">
      <h2 id="detailTitle">-</h2>
      <div class="meta" id="detailMeta"></div>
      <div class="links" id="detailLinks"></div>
      <div class="abstract" id="detailAbstract"></div>
    </div>
  </div>

  <script>
    let allPapers = [];
    let currentFiltered = [];
    const CLUSTER_COLORS = [
      '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7',
      '#dfe6e9', '#a29bfe', '#fd79a8', '#00b894', '#e17055',
      '#74b9ff', '#55efc4', '#b2bec3', '#ffeaa7', '#fab1a0'
    ];

    async function loadData() {
      try {
        const resp = await fetch('papers.json');
        allPapers = await resp.json();

        // Populate cluster filter with labels
        const clusters = [...new Set(allPapers.map(p => p.cluster))].sort((a,b) => a-b);
        const clusterSelect = document.getElementById('clusterFilter');
        clusters.forEach(c => {
          const sample = allPapers.find(p => p.cluster === c);
          const label = sample?.cluster_label || '';
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = `${c}: ${label}`;
          clusterSelect.appendChild(opt);
        });

        currentFiltered = [...allPapers];
        render(currentFiltered);
        updateStats(currentFiltered);
      } catch (e) {
        document.getElementById('stats').textContent = 'Error loading papers.json';
        console.error(e);
      }
    }

    function filterPapers() {
      const minYear = parseInt(document.getElementById('minYear').value) || 0;
      const minVenue = parseFloat(document.getElementById('minVenue').value) || 0;
      const clusterVal = document.getElementById('clusterFilter').value;
      const papersOnly = document.getElementById('papersOnly').checked;
      const notesOnly = document.getElementById('notesOnly').checked;

      return allPapers.filter(p => {
        if (p.year && p.year < minYear) return false;
        if (p.venue_quality < minVenue) return false;
        if (clusterVal !== 'all' && p.cluster !== parseInt(clusterVal)) return false;
        if (papersOnly && !p.is_paper) return false;
        if (notesOnly && !p.has_notes) return false;
        return true;
      });
    }

    function updateStats(papers) {
      const paperCount = papers.filter(p => p.is_paper).length;
      const appCount = papers.filter(p => !p.is_paper).length;
      document.getElementById('stats').textContent =
        `${papers.length} items (${paperCount} papers, ${appCount} apps/services)`;
    }

    function render(papers) {
      // Separate papers and apps
      const paperItems = papers.filter(p => p.is_paper);
      const appItems = papers.filter(p => !p.is_paper);

      // Papers trace (circles)
      const paperTrace = {
        x: paperItems.map(p => p.x),
        y: paperItems.map(p => p.y),
        text: paperItems.map(p =>
          `<b>${p.title}</b><br>` +
          `${p.venue || 'N/A'} (${p.year || 'N/A'})<br>` +
          `Cluster ${p.cluster}: ${p.cluster_label || ''}`
        ),
        customdata: paperItems,
        mode: 'markers',
        type: 'scattergl',
        name: 'Papers',
        marker: {
          size: paperItems.map(p => 8 + p.venue_quality * 2),
          color: paperItems.map(p => CLUSTER_COLORS[p.cluster % CLUSTER_COLORS.length]),
          opacity: 0.8,
          line: { width: 1, color: '#0d1117' }
        },
        hovertemplate: '%{text}<extra></extra>'
      };

      // Apps trace (diamonds)
      const appTrace = {
        x: appItems.map(p => p.x),
        y: appItems.map(p => p.y),
        text: appItems.map(p =>
          `<b>${p.title}</b><br>` +
          `App/Service<br>` +
          `Cluster ${p.cluster}: ${p.cluster_label || ''}`
        ),
        customdata: appItems,
        mode: 'markers',
        type: 'scattergl',
        name: 'Apps/Services',
        marker: {
          size: 14,
          symbol: 'diamond',
          color: appItems.map(p => CLUSTER_COLORS[p.cluster % CLUSTER_COLORS.length]),
          opacity: 0.9,
          line: { width: 2, color: '#bc8cff' }
        },
        hovertemplate: '%{text}<extra></extra>'
      };

      const layout = {
        margin: { l: 40, r: 20, t: 20, b: 40 },
        paper_bgcolor: '#0d1117',
        plot_bgcolor: '#0d1117',
        xaxis: {
          title: '',
          showgrid: true,
          gridcolor: '#21262d',
          zerolinecolor: '#30363d',
          tickfont: { color: '#8b949e' }
        },
        yaxis: {
          title: '',
          showgrid: true,
          gridcolor: '#21262d',
          zerolinecolor: '#30363d',
          tickfont: { color: '#8b949e' }
        },
        showlegend: false,
        hovermode: 'closest'
      };

      const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['lasso2d', 'select2d']
      };

      Plotly.newPlot('plot', [paperTrace, appTrace], layout, config);

      // Click handler
      document.getElementById('plot').on('plotly_click', function(data) {
        if (data.points && data.points[0]) {
          const item = data.points[0].customdata;
          showDetail(item);
        }
      });
    }

    function showDetail(item) {
      const panel = document.getElementById('detailPanel');
      panel.classList.add('active');

      document.getElementById('detailTitle').textContent = item.title || 'Untitled';

      const typeClass = item.is_paper ? 'paper' : 'app';
      const typeLabel = item.is_paper ? 'Paper' : 'App/Service';

      document.getElementById('detailMeta').innerHTML = `
        <span class="badge ${typeClass}">${typeLabel}</span>
        <span class="badge cluster">Cluster ${item.cluster}: ${item.cluster_label || ''}</span>
        <br><br>
        <span><strong>Year:</strong> ${item.year || 'N/A'}</span>
        <span><strong>Venue:</strong> ${item.venue || 'N/A'}</span>
        <span><strong>Quality:</strong> ${item.venue_quality}/5</span>
        ${item.authors ? `<br><span><strong>Authors:</strong> ${item.authors.substring(0, 100)}${item.authors.length > 100 ? '...' : ''}</span>` : ''}
        ${item.tags ? `<br><span><strong>Tags:</strong> ${item.tags}</span>` : ''}
      `;

      let linksHtml = '';
      if (item.url) {
        linksHtml += `<a href="${item.url}" target="_blank">Open URL</a>`;
      }
      if (item.doi) {
        linksHtml += `<a href="https://doi.org/${item.doi}" target="_blank">DOI</a>`;
      }
      document.getElementById('detailLinks').innerHTML = linksHtml;

      document.getElementById('detailAbstract').textContent =
        item.abstract || 'No abstract available.';
    }

    // Event handlers
    document.getElementById('applyFilter').addEventListener('click', () => {
      currentFiltered = filterPapers();
      render(currentFiltered);
      updateStats(currentFiltered);
    });

    document.getElementById('resetFilter').addEventListener('click', () => {
      document.getElementById('minYear').value = '1990';
      document.getElementById('minVenue').value = '0';
      document.getElementById('clusterFilter').value = 'all';
      document.getElementById('papersOnly').checked = false;
      document.getElementById('notesOnly').checked = false;
      currentFiltered = [...allPapers];
      render(currentFiltered);
      updateStats(currentFiltered);
    });

    // Load data
    loadData();
  </script>
</body>
</html>
